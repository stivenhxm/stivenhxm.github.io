手把手教你落地 DDD
开篇词｜带你吃透DDD
钟敬 2022-12-06

讲述：钟敬大小：11.70M时长：12:48
你好，我是钟敬，欢迎和我一起来学习领域驱动设计。
我是一名在 IT 界奋斗了二十多年的老兵。目前在 Thoughtworks 公司担任首席咨询师，也是数字化转型与运营团队的 DDD 交付负责人。平时的工作主要是给客户提供软件开发方法学、架构治理、研发效能提升等方面的帮助。
DDD，也就是“领域驱动设计”，在软件工程里，属于软件开发方法学的范畴。它继承了面向对象和敏捷方法的精华，并提炼了一套更容易掌握的原则、模式和实践，特别适合复杂的企业应用的开发。
这些年，随着数字化转型的浪潮，我们为很多家大中型企业，在几十个项目里引入了 DDD，解决了很多实际的痛点和问题。
比如说，有的企业的业务很复杂，业务人员和开发人员总是很难把需求完全说清楚，直到写完代码，用户测试的时候，才知道开发人员的理解跑偏了。采用了 DDD 以后，就可以利用领域建模，把业务知识充分地严格化和可视化。这样，在分析设计阶段，就能对齐业务和开发的理解。
还有一些系统的需求变化很快，开发很难跟上业务的节奏。有时为了能够在短期内应付变化，又会写出“打补丁”式的代码，给系统留下隐患。这种情况下，采用领域建模的方法，把领域知识抽象化，把相对稳定和相对变化的部分分开，并把变化的部分设计成可插拔、可配置的，就能开发出灵活、易扩展的系统。
另外，还有一些项目希望采用微服务架构，但是缺乏拆分的依据，不知道怎么确定服务的粒度和边界。这时通过 DDD 的领域建模和限界上下文的划分，就可以给微服务的拆分提供坚实的基础。
还有一种常见的问题，就是有些企业系统的架构和代码已经严重腐化了，希望通过重构来提高质量和可维护性。但是，应该往哪个方向重构呢？怎么在重构过程中降低风险，并且兼顾业务需求呢？
借助 DDD，就可以通过一套系统化的方法，为系统建立目标模型和设计目标架构。同时，再利用 DDD 的“柔性设计”，并且结合演进式架构和代码重构等等技术，就能很好地解决问题。
落地 DDD 有哪些困难？
事实上，我们发现，在开发微服务，遗留系统改造、架构治理、企业架构、研发效能提升、架构师培养等很多方面，DDD 都有用武之地。
DDD 有这么多的优势，可是在实践的时候，不少小伙伴都觉得不太容易学习和落地。在我们推广的过程里，发现主要有下面这几个难点。
第一，是领域建模不好掌握。不论是在 DDD，还是传统的面向对象方法学里面，领域建模都是整个过程的核心，这里面还是有不少的方法和技巧的。不过《领域驱动设计：软件核心复杂性应对之道》（以下简称《DDD》）原书的作者，大概是假设读者已经有一定的面向对象建模基础了，所以有些东西讲得也不太透。
第二，领域模型不好实现。也就是说，就算有人把领域模型建好了，不少团队也不会按照领域模型去设计数据库，设计架构，并且编写代码。而 DDD 强调，领域模型的实现必须和模型本身保持高度一致。那么，同样是因为面向对象的基础不牢，所以不懂模型的实现方法。这方面，在原书里，也没有说得太明白。
第三，是概念混乱。有些小伙伴可能已经看了不少书，听了不少讲座，但是发现 DDD 的很多概念，老师们说的好像都不一样，不知道到底该信谁的。这是因为很多人没有看原著，或者没看懂。结果，反而接受了很多二手、三手的材料。有些材料又是理解不一，甚至以讹传讹。
第四，是时代的发展。现在离 DDD 的提出，已经有二十年了。不论是技术环境还是开发理念，都已经发生了不小的变化。如果不能与时俱进，对 DDD 原来的一些理念和方法进行发展，那也很难落地。
最后，还有很多具体落地时才会遇到的问题。就算某个人自己已经掌握得很不错了，但是在团队里一推广，又会有很多障碍。比如说怎么让新、旧开发方法共存；怎么把 DDD 融入到日常开发流程；怎么评估 DDD 实施的成效等等。
DDD 怎样才能“更好学”？
虽然说了不少困难，但是你也大可不必担心。DDD 的学习还是有方法，有套路的。我希望通过这门课，把 DDD 的原理和我们在实践里总结的经验，分享给你。
为了帮你和你的团队顺利掌握和落地 DDD，解决前面说的疑难问题，这门课在设计时遵循了四个原则，我们一个一个说一下。
第一，基于认知规律
这门课基于一个贯穿始终的案例（企业管理系统）。这个案例模拟了敏捷软件开发过程，分成了三个迭代。每个迭代分成若干节课，每节课一方面引入新的知识，另一方面也会呼应和深化之前的知识。这三个迭代是这么安排的。
迭代一：夯实基础
第一个迭代，我们会开启一个“麻雀虽小，五脏俱全”的项目（配套代码链接从这里获取）。通过这个迭代，你就可以打通一个“需求 - 模型 - 代码”的最小闭环，对 DDD 的过程初步形成一个完整的“感觉”。
首先，我会利用 DDD 世界里一种常用的方法“事件风暴”，来和你一起梳理行为需求。在这个过程中，也会介绍“统一语言”。之后，我们一起来实操 DDD 的核心技能“领域建模”，并引入实体、关联、模块等几个重要的模式。接下来是模型的实现，也就是根据模型建立数据库和编写代码。你会学到 DDD 的分层架构，工厂、仓库、领域服务等模式。还会涉及到到怎样封装、怎样实现领域逻辑等等。
学完这个迭代，你应该能打下一个比较好的基础，并且有能力试着处理一些不太复杂的项目了。
迭代二：渐入佳境
第二个迭代，我们进一步深入，讲几个 DDD 里争议较大，不太好掌握的内容。
我会先从理论、模型和编码层面帮你理解“聚合”。同时，会进一步带你提升领域建模能力，深化对分层架构和代码封装的理解。接着，我们会用几节课讲值对象，带你理解值对象的本质和优点，并解决值对象在建模和编程上的一些具体问题。最后，我们会学习一个重要的建模技巧——泛化，这是领域建模由初级走向中、高级的关键技能。
经过第二个迭代的揣摩，你应该会有渐入佳境的感觉了。
迭代三：掌握更高级的技能
经过前两个迭代，你对一个开发组范围内的项目应该有一定信心了。但是如果项目范围更大，该怎么处理呢？
在第三个迭代，我会介绍“限界上下文”模式，通过分而治之来维护概念的一致性。在这个基础上，再进一步学习微服务设计。
接下来，我会带你了解事件驱动和 CQRS 这两个重要的架构模式。然后，我们会讨论怎样为更加灵活多变的业务建模，并深化对泛化的理解。最后，我们会解决在实际落地过程中会遇到的几个问题，比如 DDD 切入点的选择，遗留系统的改造等等。
经过这三个迭代的学习，你已经掌握了 DDD 最核心的技能，再经过一段时间的实践和消化，就可以向 DDD“专家”迈进了。
第二，是立足原书，有所发展
这门课基于《DDD》原书的理论框架，力求准确地反映书里的知识体系。但这也并不意味着本本主义，不是说书里的一定就是对的。我会首先解释清楚原书的概念，并对值得商榷的地方做深入分析。对原书里没有讲透的部分，也会通过实例进一步讲解。
随着时代的发展，还出现了和 DDD 相关的新内容和新观点，比如前面提到过的微服务设计、事件驱动架构、CQRS，还有对贫血模型和富领域模型的权衡等等，这些你都会在课程里讲到。
第三，是补足面向对象基础
前面说过，《DDD》原书的作者，其实是假设读者已经有了一定面向对象方法学的基础，比如说，分析和设计的基本理念、UML 的使用、模型到代码的转换等等。不过学习这门课，不需要你系统地掌握面向对象方法学。我会在讲解过程中，结合 DDD 的知识点，详细介绍必要的面向对象知识和技能，帮助你扫清学习障碍。
最后，是面向实践，避免空谈
这门课基本上都是按照“问题 - 方案”的模式。也就是说，首先由需求引发要解决的问题，然后找到解决问题的知识点，并进行讲解。每个知识点都有具体的建模或编码实现来说明，避免空谈理论。
写在最后
和很多 IT 技术一样，DDD 不是纯理论的，而是一门“手艺”，必须动手练习才能真正学懂。
你可以跟着我建模型、写代码，拾级而上。最终，让你在心里潜移默化地建立起完整的知识图景，掌握 DDD 最核心的技能。如果可以在自己的项目里用起来，感受应该会更加深刻。

知识地图
当你学到课程中间部分的时候，就可以读一下《DDD》原书来加深理解，还可以通过其他参考书扩展视野。比如说，如果想深入学习 UML，可以读一下《UML 用户指南》和《UML 精粹》；想了解真正复杂的领域模型长什么样，可以看看《分析模式：可复用的对象模型》等等。另外，你还可以把自己学习到的知识，讲给团队的小伙伴听，达到教学相长的目的。
最后，我想说的是，DDD 不仅是一门技术，更是一门艺术。而你既然想学习 DDD，恐怕也不仅仅是为了应付某个具体的问题，而是多少带着一些情怀来的。你可能想要了解，几十年来，那些研究软件开发方法学的大师们，到底总结出了怎样的经验；也可能希望发扬工匠精神，成为一个技艺卓越的软件开发者。
那么，就让我们一起，开始这个充满乐趣的探索之旅吧。


02｜迭代一概述：怎样开启一个麻雀虽小五脏俱全的项目？
钟敬 2022-12-08



1.0x

讲述：钟敬大小：13.56M时长：14:51
你好，我是钟敬。今天咱们开始第一个迭代。
在开篇词中我们说过，为了让你更好地掌握 DDD，咱们这门课设置了一个贯穿始终的案例。我们会模仿真实的敏捷开发过程，把案例分成三个迭代，每个迭代的需求规模逐渐扩大，复杂性也逐渐增加。为了满足变化的需求，就会出现新的问题，为了解决这些问题，咱们就会引入新的 DDD 模式和实践，或者深化之前学过的知识。
今天开始，咱们通过迭代一，实现一个“麻雀虽小、五脏俱全”的项目。打通从需求分析，到领域建模，再到架构设计，最后到数据库和代码实现的完整闭环。
学完迭代一，你就可以理解 DDD 实践中那些最基本的套路了，甚至还可以在自己实际工作的项目里，选择一个小的“切片”，开始尝试落地 DDD。
当然了，在实践过程中，你可能也会遇到这样那样的问题，别急，这些问题的答案，很可能就在迭代二和迭代三的内容里。当然，你也可以把问题写在评论区，咱们一起讨论。
现在我们就来看一下这个迭代的具体需求。
这次迭代的需求
假设咱们俩要一起创业，经过了一轮市场调研，我们发现很多中小企业，都有诸如考勤管理、工时管理、项目管理、请假管理等通用的需求。我们姑且把这些应用统称为“企业管理系统”。
现在咱们顺便回顾一下领域驱动设计里“领域”这个词的含义。领域指的是软件要解决的那些业务问题，所以也可以叫业务领域，英文叫 Business Domain。在这个例子里，“企业管理”就是咱们要处理的领域。
过去，这些企业只能自建或购买软件系统，安装到公司内部的服务器上，甚至还要有自己的机房，软硬件以及运维成本都比较高。如果咱们能够把这些应用放在云上，那么企业就只需要有选择地购买我们提供的服务，按需付费就好了，不再需要自建机房，也不需要自己运维，可以有效降低企业的成本。
咱们这种系统，其实是基于 SaaS 的应用。所谓 SaaS，英文全称是 Software-as-a-Service，中文译作“软件即服务”。也就是说，软件不再像传统上那样交付并安装在客户本地，而是安装到云上，成为客户可以直接使用的服务。
SaaS 应用往往有个特点，用户五花八门，需求也是复杂多变。有些应用，如果只针对一个企业开发，本来挺简单，一旦放到云上，需求复杂性就会急剧上升。所以这次迭代，我们先做最简单的需求，后面两个迭代中我们再逐渐增加更多的灵活性。
由于云原生是这两年的热点，所以咱们凭这个点子幸运地拉到了投资，成立了一个叫做“卷卷通”的公司，开始着手研发系统的第一个版本。
由于不同行业的需求可能有较大差别，我们决定先聚焦于一个细分市场，之后再扩大范围。这个细分市场是我们比较熟悉的软件服务企业。这些企业会向自己的客户提供软件咨询、软件开发等等服务。
我们发现，这些企业的员工一般都工作在各个项目上。企业为了满足管理诉求，希望员工每周在系统中填报自己在哪些项目上花了多少时间，也就是所谓的报工时。所以我们第一步先来满足这个功能。但是，为了完成报工时的功能，我们还要首先对组织、人员、项目等等进行管理。
这里还要说一下，在领域驱动设计中有一个重要的角色叫做“领域专家”，叫业务专家也可以。领域专家需要对业务有总体性和本质性的把握，同时对业务发展也要有一定前瞻性，也就是说，心里要有一盘棋。
所以领域专家往往不是一线业务操作人员，在很多企业中，是那些干了很多年业务，逐渐成长起来的中级管理干部。还有一些企业，由产品经理担任领域专家。
那么，下面就由我暂时充当一下领域专家，详细说一下需求。
需求一：租户管理
这个系统可以给多家企业使用，每家企业的数据是隔离的。这些作为客户的企业，在云原生应用里，习惯上叫做“租户（tenant）”。咱们的系统就是要对这些租户进行增删改查等管理。这样的系统叫多租户系统。
假设我们做市场调研时，研究了一家叫“零零后科技有限公司”的企业，我们这个迭代，就先来满足这家企业的需求。
需求二：人员与组织管理
除了对租户进行增删改查等管理，我们还必须还有人员和组织管理。
零零后公司有多个开发中心，每个开发中心下有多个开发组。此外，还有公司直属的人事部、财务部等部门，系统要能够管理这些部门。
而且，我们对员工也要进行增删改查，并且把员工分配到部门。每个员工只能属于一个部门，比如王小牛属于开发一组。
下面这个图说明了需求中的人员和组织结构：

需求三：项目管理
接下来的需求是项目管理。
首先，租户要向它的客户提供服务，就要和客户签订合同，然后完成合同下的项目。比如说，租户零零后公司的客户可能包括安安保险公司、开心电信等等。那么，租户零零后公司就得为安安保险公司，安排一堆程序员帮他们开发核心保险系统项目，也得为开心电信，安排几个咨询师帮他们的敏捷转型做咨询。
这里具体的需求是这样的：
一个租户企业可以有多个客户，可以在系统里对客户信息进行增删改查，每个客户都有一个客户经理来跟进；
租户可以和它的客户签订多份合同，在系统中对合同信息进行增删改查，每个合同都有一个销售人员负责，可以开始和结束合同；
一个合同下可以有多个项目，系统可以对项目进行增删改查，每个项目有一个项目经理；
可以在系统中开始和结束项目，需要记录开始和结束时间等信息。项目结束以后，很多事情就不能随便做了。
下图说明了客户、合同、项目等概念的关系：

需求四：人员分配
有了项目，我们就可以把员工分配到项目上，也可以让一个人退出项目。而且，一个项目可以有多个人参与，一个人又可以同时参与多个项目。
除了这些，我们在把人分配到项目上的时候，还要记录每个人预计的投入百分比。比如说，王小牛在 A 项目上准备投入自己 30% 的时间，同时在 B 项目准备投入 40% 的时间等等。
之所以要记录预计的投入时间，是为了让企业能够在总体上调配人力资源。比如说管理人员看到王小牛还有 30% 的空余时间，就可以把它同时再安排到另一个项目上，以便实现“内卷最大化”。
下图说明了人员和项目投入的关系：

需求五：工时登记
把人员分配到项目上以后，我们就可以登记工时了。
我们这里规定只有当一个员工分配到一个项目上以后，才能通过这个项目报工时。这样的规定，一来是为了符合公司的管理要求，一个员工不能随意参加一个项目；二来也可以防止员工不小心把工时填到错误的项目上。
而且每个员工每周都需要在系统中填报工时，登记自己哪一天在哪个项目上投入了多少时间。当然，员工可对工时进行查询和修改，还可以为每天的投入的时间填写备注。你可以看一看工时登记的界面原型，进一步理解需求。

工时登记界面原型图
另外，尽管咱们尽量采用接近真实的案例，但也无法面面俱到。为了突出重点，我们这个课程还是省略了一些需求，比如说人员登录和权限控制等等。
现在，第一个迭代的需求基本上就说完了。这些需求看起来简单，其实关键点还是挺多的。而且更重要的是，在实际项目里，这些需求未必会这么清清楚楚、白纸黑字地列出来给你，更多是隐藏在领域专家的脑子里，需要我们去挖掘。
还有一些需求，我故意没有说得很详细，而是要在后续的开发过程中逐步揭示。这也是为了模拟实际项目的场景。
DDD 的基本开发过程
那么，我们怎么用一套系统化的方法，抽丝剥茧、一步一步地把需求落实到代码呢？咱们看看下面这张图，它表示了领域驱动设计中的主要流程。

领域驱动设计主要的开发流程
你可以看到，在整个开发流程中，首先是要捕获行为需求，也就是传统软件工程里的“获取需求”。这一步，我们要识别需求里有哪些流程、哪些功能，每个功能由什么人操作，会产生什么结果。
在传统软件工程中，这一步常用的方式是用例建模，也就是用 Use Case 来建模。在这套课程里面，我们会用 DDD 中比较流行的一种方法，叫做“事件风暴”。
接下来，我们就可以进行领域建模了，也就是通过建立领域模型，把需求里的主要业务知识描述清楚。DDD 的领域模型，大体上相当于传统软件工程中的分析模型。
基于领域模型，我们就可以做架构设计，包括进程间和进程内的架构。比如说微服务设计、中台设计都属于进程间架构。而 DDD 分层架构，通常说的是进程内架构。
然后就可以根据领域模型进行数据库设计，最后是代码实现。
这样，就形成了一个基于 DDD 的开发闭环。其实，在实践中，尤其是对敏捷软件开发来说，这些步骤不是线性的，而是反复迭代、互相穿插的。
DDD 是以领域模型为核心的。所以，我们可以把上面说的步骤分成模型的建立和模型的实现两部分。
模型的建立阶段，使用的都是业务术语，归根结底来自业务人员，业务人员不仅能听懂，而且负责评价建模的正确性。而模型的实现，则是业务人员不需要理解也不关注的，会包含技术实现方面的内容。这两者的边界很重要，我们在后面还会反复提到。
总结
好，今天就讲到这里，我们来总结一下。
这节课，我们概述了迭代一的目的和需求，并且介绍了 DDD 的基本开发过程。
咱们要开发的是一个基于 SaaS 的企业管理系统，它的需求主要包括租户管理、人员与组织管理、项目管理、人员分配和工时登记这几部分。
在介绍需求的同时，我们也穿插着介绍了领域和领域专家的概念。领域就是软件要解决的业务问题。领域专家则是十分了解业务知识本质的人。
DDD 开发的基本流程是以领域模型为核心的。整个流程可以分为模型的建立和模型的实现两部分。其中模型的建立一定要使用业务语言，而模型的实现则增加了技术语言。模型的建立，是通过领域专家和开发人员的协作共同完成的。
最后，今天讲的所有需求我都汇总到了下面这张表里，你可以看一下，方便后面的实战。

思考题
1. 如果这是一个真实的项目，你觉得还缺少哪些需求？
2. 希望在你自己的项目里，选择一个不太复杂的部分，然后跟着后续的课程，按照 DDD 的方法尝试实践。
好，今天的课程结束了，有什么问题欢迎在评论区留言，下一节课我们将通过事件风暴的方式，理清系统的行为需求，并为进一步的领域建模打下基础。
