手把手教你落地 DDD
开篇词｜带你吃透DDD
钟敬 2022-12-06

讲述：钟敬大小：11.70M时长：12:48
你好，我是钟敬，欢迎和我一起来学习领域驱动设计。
我是一名在 IT 界奋斗了二十多年的老兵。目前在 Thoughtworks 公司担任首席咨询师，也是数字化转型与运营团队的 DDD 交付负责人。平时的工作主要是给客户提供软件开发方法学、架构治理、研发效能提升等方面的帮助。
DDD，也就是“领域驱动设计”，在软件工程里，属于软件开发方法学的范畴。它继承了面向对象和敏捷方法的精华，并提炼了一套更容易掌握的原则、模式和实践，特别适合复杂的企业应用的开发。
这些年，随着数字化转型的浪潮，我们为很多家大中型企业，在几十个项目里引入了 DDD，解决了很多实际的痛点和问题。
比如说，有的企业的业务很复杂，业务人员和开发人员总是很难把需求完全说清楚，直到写完代码，用户测试的时候，才知道开发人员的理解跑偏了。采用了 DDD 以后，就可以利用领域建模，把业务知识充分地严格化和可视化。这样，在分析设计阶段，就能对齐业务和开发的理解。
还有一些系统的需求变化很快，开发很难跟上业务的节奏。有时为了能够在短期内应付变化，又会写出“打补丁”式的代码，给系统留下隐患。这种情况下，采用领域建模的方法，把领域知识抽象化，把相对稳定和相对变化的部分分开，并把变化的部分设计成可插拔、可配置的，就能开发出灵活、易扩展的系统。
另外，还有一些项目希望采用微服务架构，但是缺乏拆分的依据，不知道怎么确定服务的粒度和边界。这时通过 DDD 的领域建模和限界上下文的划分，就可以给微服务的拆分提供坚实的基础。
还有一种常见的问题，就是有些企业系统的架构和代码已经严重腐化了，希望通过重构来提高质量和可维护性。但是，应该往哪个方向重构呢？怎么在重构过程中降低风险，并且兼顾业务需求呢？
借助 DDD，就可以通过一套系统化的方法，为系统建立目标模型和设计目标架构。同时，再利用 DDD 的“柔性设计”，并且结合演进式架构和代码重构等等技术，就能很好地解决问题。
落地 DDD 有哪些困难？
事实上，我们发现，在开发微服务，遗留系统改造、架构治理、企业架构、研发效能提升、架构师培养等很多方面，DDD 都有用武之地。
DDD 有这么多的优势，可是在实践的时候，不少小伙伴都觉得不太容易学习和落地。在我们推广的过程里，发现主要有下面这几个难点。
第一，是领域建模不好掌握。不论是在 DDD，还是传统的面向对象方法学里面，领域建模都是整个过程的核心，这里面还是有不少的方法和技巧的。不过《领域驱动设计：软件核心复杂性应对之道》（以下简称《DDD》）原书的作者，大概是假设读者已经有一定的面向对象建模基础了，所以有些东西讲得也不太透。
第二，领域模型不好实现。也就是说，就算有人把领域模型建好了，不少团队也不会按照领域模型去设计数据库，设计架构，并且编写代码。而 DDD 强调，领域模型的实现必须和模型本身保持高度一致。那么，同样是因为面向对象的基础不牢，所以不懂模型的实现方法。这方面，在原书里，也没有说得太明白。
第三，是概念混乱。有些小伙伴可能已经看了不少书，听了不少讲座，但是发现 DDD 的很多概念，老师们说的好像都不一样，不知道到底该信谁的。这是因为很多人没有看原著，或者没看懂。结果，反而接受了很多二手、三手的材料。有些材料又是理解不一，甚至以讹传讹。
第四，是时代的发展。现在离 DDD 的提出，已经有二十年了。不论是技术环境还是开发理念，都已经发生了不小的变化。如果不能与时俱进，对 DDD 原来的一些理念和方法进行发展，那也很难落地。
最后，还有很多具体落地时才会遇到的问题。就算某个人自己已经掌握得很不错了，但是在团队里一推广，又会有很多障碍。比如说怎么让新、旧开发方法共存；怎么把 DDD 融入到日常开发流程；怎么评估 DDD 实施的成效等等。
DDD 怎样才能“更好学”？
虽然说了不少困难，但是你也大可不必担心。DDD 的学习还是有方法，有套路的。我希望通过这门课，把 DDD 的原理和我们在实践里总结的经验，分享给你。
为了帮你和你的团队顺利掌握和落地 DDD，解决前面说的疑难问题，这门课在设计时遵循了四个原则，我们一个一个说一下。
第一，基于认知规律
这门课基于一个贯穿始终的案例（企业管理系统）。这个案例模拟了敏捷软件开发过程，分成了三个迭代。每个迭代分成若干节课，每节课一方面引入新的知识，另一方面也会呼应和深化之前的知识。这三个迭代是这么安排的。
迭代一：夯实基础
第一个迭代，我们会开启一个“麻雀虽小，五脏俱全”的项目（配套代码链接从这里获取）。通过这个迭代，你就可以打通一个“需求 - 模型 - 代码”的最小闭环，对 DDD 的过程初步形成一个完整的“感觉”。
首先，我会利用 DDD 世界里一种常用的方法“事件风暴”，来和你一起梳理行为需求。在这个过程中，也会介绍“统一语言”。之后，我们一起来实操 DDD 的核心技能“领域建模”，并引入实体、关联、模块等几个重要的模式。接下来是模型的实现，也就是根据模型建立数据库和编写代码。你会学到 DDD 的分层架构，工厂、仓库、领域服务等模式。还会涉及到到怎样封装、怎样实现领域逻辑等等。
学完这个迭代，你应该能打下一个比较好的基础，并且有能力试着处理一些不太复杂的项目了。
迭代二：渐入佳境
第二个迭代，我们进一步深入，讲几个 DDD 里争议较大，不太好掌握的内容。
我会先从理论、模型和编码层面帮你理解“聚合”。同时，会进一步带你提升领域建模能力，深化对分层架构和代码封装的理解。接着，我们会用几节课讲值对象，带你理解值对象的本质和优点，并解决值对象在建模和编程上的一些具体问题。最后，我们会学习一个重要的建模技巧——泛化，这是领域建模由初级走向中、高级的关键技能。
经过第二个迭代的揣摩，你应该会有渐入佳境的感觉了。
迭代三：掌握更高级的技能
经过前两个迭代，你对一个开发组范围内的项目应该有一定信心了。但是如果项目范围更大，该怎么处理呢？
在第三个迭代，我会介绍“限界上下文”模式，通过分而治之来维护概念的一致性。在这个基础上，再进一步学习微服务设计。
接下来，我会带你了解事件驱动和 CQRS 这两个重要的架构模式。然后，我们会讨论怎样为更加灵活多变的业务建模，并深化对泛化的理解。最后，我们会解决在实际落地过程中会遇到的几个问题，比如 DDD 切入点的选择，遗留系统的改造等等。
经过这三个迭代的学习，你已经掌握了 DDD 最核心的技能，再经过一段时间的实践和消化，就可以向 DDD“专家”迈进了。
第二，是立足原书，有所发展
这门课基于《DDD》原书的理论框架，力求准确地反映书里的知识体系。但这也并不意味着本本主义，不是说书里的一定就是对的。我会首先解释清楚原书的概念，并对值得商榷的地方做深入分析。对原书里没有讲透的部分，也会通过实例进一步讲解。
随着时代的发展，还出现了和 DDD 相关的新内容和新观点，比如前面提到过的微服务设计、事件驱动架构、CQRS，还有对贫血模型和富领域模型的权衡等等，这些你都会在课程里讲到。
第三，是补足面向对象基础
前面说过，《DDD》原书的作者，其实是假设读者已经有了一定面向对象方法学的基础，比如说，分析和设计的基本理念、UML 的使用、模型到代码的转换等等。不过学习这门课，不需要你系统地掌握面向对象方法学。我会在讲解过程中，结合 DDD 的知识点，详细介绍必要的面向对象知识和技能，帮助你扫清学习障碍。
最后，是面向实践，避免空谈
这门课基本上都是按照“问题 - 方案”的模式。也就是说，首先由需求引发要解决的问题，然后找到解决问题的知识点，并进行讲解。每个知识点都有具体的建模或编码实现来说明，避免空谈理论。
写在最后
和很多 IT 技术一样，DDD 不是纯理论的，而是一门“手艺”，必须动手练习才能真正学懂。
你可以跟着我建模型、写代码，拾级而上。最终，让你在心里潜移默化地建立起完整的知识图景，掌握 DDD 最核心的技能。如果可以在自己的项目里用起来，感受应该会更加深刻。

知识地图
当你学到课程中间部分的时候，就可以读一下《DDD》原书来加深理解，还可以通过其他参考书扩展视野。比如说，如果想深入学习 UML，可以读一下《UML 用户指南》和《UML 精粹》；想了解真正复杂的领域模型长什么样，可以看看《分析模式：可复用的对象模型》等等。另外，你还可以把自己学习到的知识，讲给团队的小伙伴听，达到教学相长的目的。
最后，我想说的是，DDD 不仅是一门技术，更是一门艺术。而你既然想学习 DDD，恐怕也不仅仅是为了应付某个具体的问题，而是多少带着一些情怀来的。你可能想要了解，几十年来，那些研究软件开发方法学的大师们，到底总结出了怎样的经验；也可能希望发扬工匠精神，成为一个技艺卓越的软件开发者。
那么，就让我们一起，开始这个充满乐趣的探索之旅吧。


02｜迭代一概述：怎样开启一个麻雀虽小五脏俱全的项目？
钟敬 2022-12-08



1.0x

讲述：钟敬大小：13.56M时长：14:51
你好，我是钟敬。今天咱们开始第一个迭代。
在开篇词中我们说过，为了让你更好地掌握 DDD，咱们这门课设置了一个贯穿始终的案例。我们会模仿真实的敏捷开发过程，把案例分成三个迭代，每个迭代的需求规模逐渐扩大，复杂性也逐渐增加。为了满足变化的需求，就会出现新的问题，为了解决这些问题，咱们就会引入新的 DDD 模式和实践，或者深化之前学过的知识。
今天开始，咱们通过迭代一，实现一个“麻雀虽小、五脏俱全”的项目。打通从需求分析，到领域建模，再到架构设计，最后到数据库和代码实现的完整闭环。
学完迭代一，你就可以理解 DDD 实践中那些最基本的套路了，甚至还可以在自己实际工作的项目里，选择一个小的“切片”，开始尝试落地 DDD。
当然了，在实践过程中，你可能也会遇到这样那样的问题，别急，这些问题的答案，很可能就在迭代二和迭代三的内容里。当然，你也可以把问题写在评论区，咱们一起讨论。
现在我们就来看一下这个迭代的具体需求。
这次迭代的需求
假设咱们俩要一起创业，经过了一轮市场调研，我们发现很多中小企业，都有诸如考勤管理、工时管理、项目管理、请假管理等通用的需求。我们姑且把这些应用统称为“企业管理系统”。
现在咱们顺便回顾一下领域驱动设计里“领域”这个词的含义。领域指的是软件要解决的那些业务问题，所以也可以叫业务领域，英文叫 Business Domain。在这个例子里，“企业管理”就是咱们要处理的领域。
过去，这些企业只能自建或购买软件系统，安装到公司内部的服务器上，甚至还要有自己的机房，软硬件以及运维成本都比较高。如果咱们能够把这些应用放在云上，那么企业就只需要有选择地购买我们提供的服务，按需付费就好了，不再需要自建机房，也不需要自己运维，可以有效降低企业的成本。
咱们这种系统，其实是基于 SaaS 的应用。所谓 SaaS，英文全称是 Software-as-a-Service，中文译作“软件即服务”。也就是说，软件不再像传统上那样交付并安装在客户本地，而是安装到云上，成为客户可以直接使用的服务。
SaaS 应用往往有个特点，用户五花八门，需求也是复杂多变。有些应用，如果只针对一个企业开发，本来挺简单，一旦放到云上，需求复杂性就会急剧上升。所以这次迭代，我们先做最简单的需求，后面两个迭代中我们再逐渐增加更多的灵活性。
由于云原生是这两年的热点，所以咱们凭这个点子幸运地拉到了投资，成立了一个叫做“卷卷通”的公司，开始着手研发系统的第一个版本。
由于不同行业的需求可能有较大差别，我们决定先聚焦于一个细分市场，之后再扩大范围。这个细分市场是我们比较熟悉的软件服务企业。这些企业会向自己的客户提供软件咨询、软件开发等等服务。
我们发现，这些企业的员工一般都工作在各个项目上。企业为了满足管理诉求，希望员工每周在系统中填报自己在哪些项目上花了多少时间，也就是所谓的报工时。所以我们第一步先来满足这个功能。但是，为了完成报工时的功能，我们还要首先对组织、人员、项目等等进行管理。
这里还要说一下，在领域驱动设计中有一个重要的角色叫做“领域专家”，叫业务专家也可以。领域专家需要对业务有总体性和本质性的把握，同时对业务发展也要有一定前瞻性，也就是说，心里要有一盘棋。
所以领域专家往往不是一线业务操作人员，在很多企业中，是那些干了很多年业务，逐渐成长起来的中级管理干部。还有一些企业，由产品经理担任领域专家。
那么，下面就由我暂时充当一下领域专家，详细说一下需求。
需求一：租户管理
这个系统可以给多家企业使用，每家企业的数据是隔离的。这些作为客户的企业，在云原生应用里，习惯上叫做“租户（tenant）”。咱们的系统就是要对这些租户进行增删改查等管理。这样的系统叫多租户系统。
假设我们做市场调研时，研究了一家叫“零零后科技有限公司”的企业，我们这个迭代，就先来满足这家企业的需求。
需求二：人员与组织管理
除了对租户进行增删改查等管理，我们还必须还有人员和组织管理。
零零后公司有多个开发中心，每个开发中心下有多个开发组。此外，还有公司直属的人事部、财务部等部门，系统要能够管理这些部门。
而且，我们对员工也要进行增删改查，并且把员工分配到部门。每个员工只能属于一个部门，比如王小牛属于开发一组。
下面这个图说明了需求中的人员和组织结构：

需求三：项目管理
接下来的需求是项目管理。
首先，租户要向它的客户提供服务，就要和客户签订合同，然后完成合同下的项目。比如说，租户零零后公司的客户可能包括安安保险公司、开心电信等等。那么，租户零零后公司就得为安安保险公司，安排一堆程序员帮他们开发核心保险系统项目，也得为开心电信，安排几个咨询师帮他们的敏捷转型做咨询。
这里具体的需求是这样的：
一个租户企业可以有多个客户，可以在系统里对客户信息进行增删改查，每个客户都有一个客户经理来跟进；
租户可以和它的客户签订多份合同，在系统中对合同信息进行增删改查，每个合同都有一个销售人员负责，可以开始和结束合同；
一个合同下可以有多个项目，系统可以对项目进行增删改查，每个项目有一个项目经理；
可以在系统中开始和结束项目，需要记录开始和结束时间等信息。项目结束以后，很多事情就不能随便做了。
下图说明了客户、合同、项目等概念的关系：

需求四：人员分配
有了项目，我们就可以把员工分配到项目上，也可以让一个人退出项目。而且，一个项目可以有多个人参与，一个人又可以同时参与多个项目。
除了这些，我们在把人分配到项目上的时候，还要记录每个人预计的投入百分比。比如说，王小牛在 A 项目上准备投入自己 30% 的时间，同时在 B 项目准备投入 40% 的时间等等。
之所以要记录预计的投入时间，是为了让企业能够在总体上调配人力资源。比如说管理人员看到王小牛还有 30% 的空余时间，就可以把它同时再安排到另一个项目上，以便实现“内卷最大化”。
下图说明了人员和项目投入的关系：

需求五：工时登记
把人员分配到项目上以后，我们就可以登记工时了。
我们这里规定只有当一个员工分配到一个项目上以后，才能通过这个项目报工时。这样的规定，一来是为了符合公司的管理要求，一个员工不能随意参加一个项目；二来也可以防止员工不小心把工时填到错误的项目上。
而且每个员工每周都需要在系统中填报工时，登记自己哪一天在哪个项目上投入了多少时间。当然，员工可对工时进行查询和修改，还可以为每天的投入的时间填写备注。你可以看一看工时登记的界面原型，进一步理解需求。

工时登记界面原型图
另外，尽管咱们尽量采用接近真实的案例，但也无法面面俱到。为了突出重点，我们这个课程还是省略了一些需求，比如说人员登录和权限控制等等。
现在，第一个迭代的需求基本上就说完了。这些需求看起来简单，其实关键点还是挺多的。而且更重要的是，在实际项目里，这些需求未必会这么清清楚楚、白纸黑字地列出来给你，更多是隐藏在领域专家的脑子里，需要我们去挖掘。
还有一些需求，我故意没有说得很详细，而是要在后续的开发过程中逐步揭示。这也是为了模拟实际项目的场景。
DDD 的基本开发过程
那么，我们怎么用一套系统化的方法，抽丝剥茧、一步一步地把需求落实到代码呢？咱们看看下面这张图，它表示了领域驱动设计中的主要流程。

领域驱动设计主要的开发流程
你可以看到，在整个开发流程中，首先是要捕获行为需求，也就是传统软件工程里的“获取需求”。这一步，我们要识别需求里有哪些流程、哪些功能，每个功能由什么人操作，会产生什么结果。
在传统软件工程中，这一步常用的方式是用例建模，也就是用 Use Case 来建模。在这套课程里面，我们会用 DDD 中比较流行的一种方法，叫做“事件风暴”。
接下来，我们就可以进行领域建模了，也就是通过建立领域模型，把需求里的主要业务知识描述清楚。DDD 的领域模型，大体上相当于传统软件工程中的分析模型。
基于领域模型，我们就可以做架构设计，包括进程间和进程内的架构。比如说微服务设计、中台设计都属于进程间架构。而 DDD 分层架构，通常说的是进程内架构。
然后就可以根据领域模型进行数据库设计，最后是代码实现。
这样，就形成了一个基于 DDD 的开发闭环。其实，在实践中，尤其是对敏捷软件开发来说，这些步骤不是线性的，而是反复迭代、互相穿插的。
DDD 是以领域模型为核心的。所以，我们可以把上面说的步骤分成模型的建立和模型的实现两部分。
模型的建立阶段，使用的都是业务术语，归根结底来自业务人员，业务人员不仅能听懂，而且负责评价建模的正确性。而模型的实现，则是业务人员不需要理解也不关注的，会包含技术实现方面的内容。这两者的边界很重要，我们在后面还会反复提到。
总结
好，今天就讲到这里，我们来总结一下。
这节课，我们概述了迭代一的目的和需求，并且介绍了 DDD 的基本开发过程。
咱们要开发的是一个基于 SaaS 的企业管理系统，它的需求主要包括租户管理、人员与组织管理、项目管理、人员分配和工时登记这几部分。
在介绍需求的同时，我们也穿插着介绍了领域和领域专家的概念。领域就是软件要解决的业务问题。领域专家则是十分了解业务知识本质的人。
DDD 开发的基本流程是以领域模型为核心的。整个流程可以分为模型的建立和模型的实现两部分。其中模型的建立一定要使用业务语言，而模型的实现则增加了技术语言。模型的建立，是通过领域专家和开发人员的协作共同完成的。
最后，今天讲的所有需求我都汇总到了下面这张表里，你可以看一下，方便后面的实战。

思考题
1. 如果这是一个真实的项目，你觉得还缺少哪些需求？
2. 希望在你自己的项目里，选择一个不太复杂的部分，然后跟着后续的课程，按照 DDD 的方法尝试实践。
好，今天的课程结束了，有什么问题欢迎在评论区留言，下一节课我们将通过事件风暴的方式，理清系统的行为需求，并为进一步的领域建模打下基础。



03｜事件风暴（上）：怎样和业务愉快地聊需求？
钟敬 2022-12-10


讲述：钟敬大小：15.65M时长：17:08
你好，我是钟敬。
上一讲，我们正式开始了第一个迭代，并简单分析了迭代一的需求。今天，咱们就要根据 DDD 的基本开发流程，使用事件风暴方法来进一步梳理需求。
你可能会问，上一讲的需求好像已经说得挺清楚了，为什么还要用专门的方法来梳理呢？
其实，在真实项目，尤其是敏捷项目里，领域专家很可能不会像我们上一讲那样，一开始就把需求都一一列出来，需求可能仅仅停留在领域专家的脑子里。所以，我们就需要一种方法，能够将这些头脑中的需求挖掘出来。
而且，即便领域专家已经把需求写出来，我们也很难保证没有遗漏，保证开发人员都彻底理解了。而事件风暴不仅能帮助我们尽量把需求补充完全，而且还能以协作的方式保证业务人员和技术人员对需求理解一致。
此外，事件风暴方法也能够帮助我们识别领域对象，这也是我们进行领域建模前的重要一步。尽管对于建模高手来说，通过“聊天”的方式就能把模型画出来，但对于多数开发团队而言，还是需要一种套路化的方法作为辅助，一步一步地做。
这节课我们从实践入手，让你真正掌握事件风暴的概念和具体操作。
事件风暴是怎么一回事？
那么，事件风暴是怎么来的呢？
一般来说，为了理解需求，我们首先要分析系统具有哪些功能，这些功能由什么人操作，会产生什么效果。这个过程传统上叫做“捕获行为需求”。
捕获行为需求的方法有好几种，在传统的软件工程中，最常用的方法是“用例”，也就是 Use Case。但是，Eric Evans 在《领域驱动设计》这本书里，并没有规定捕获行为需求的具体方法。直到 2013 年，一位叫 Alberto 的 DDD 专家提出了“事件风暴”，也就是 Event Storming。
这种方法简单易学，而且充分体现了 DDD 中沟通协作、统一语言等要点，所以逐渐开始流行起来。你可以先看看这张图，这里说明了事件风暴的主要过程：

这里的第一步是识别领域事件，在这一步，我们要找到业务流程中发生了哪些事情；第二步是识别命令，进一步说明是什么角色，做了什么操作，导致上述事情的发生；而第三步是识别领域名词，从领域事件和命令中找到名词性概念，为进一步的领域建模打下基础。这里每一步的具体做法和要点，我们后面都会详细介绍。
那么现在，咱们就来想象一下如何在真实的项目中一起做事件风暴。为了保证把细节讲清楚，我们会分为两节课进行，今天的课先聚焦于第一步，识别领域事件。
我再强调一句，由于事件风暴是一个动态的协作过程，不太容易通过文字表达，所以在看后面内容的时候，你一定要充分发挥想象力，让头脑中有“画面感”，脑补出咱们两个人唇枪舌剑，反复讨论的过程。
事件风暴的准备
不过，在正式开始事件风暴之前，我们还要先做一些准备工作。
首先是人员的准备。事件风暴要求业务和技术人员共同协作。业务人员，也就是之前说过的“领域专家”，在实践中一般由业务部门的专家，或者产品经理、PO（Product Owner）、BA（Business Analyst）等角色来担任。技术人员呢，首先要有架构师，其次也可以有技术经理，或者其他的开发人员、测试人员也可以参加。
第二是场地准备。我们需要找一个比较大的会议室，或者至少有一面足够长的墙。
最后是器材准备。我们需要几套彩色的便利贴，到时候我们会把事件风暴的主要内容写在上面。另外，通常还要一卷一开的大白纸，把这些白纸打横，一字排开，贴在会议室的墙上，用来贴便利贴。
事件风暴的第一步：识别领域事件
好，现在还是我来扮演产品经理，你来扮演架构师。而且假设我以前做过事件风暴，而你是第一次，所以我比你知道得多一点。
一开始，我先口头给你讲了一遍需求，你大概听懂了。然后我们就开始事件风暴的第一步：识别领域事件。
所谓领域事件，就是在业务过程中，业务人员要关注的那些已经发生的事儿。比方说，对于电子商务系统，订单已提交、商品已签收等等，都是领域事件。实际上，领域事件表示的是，业务流程中每个步骤引发的结果。事件风暴的作者认为，从结果入手来梳理需求，比从操作入手，更容易把业务想清楚。事件风暴中的“事件”两个字就来源于领域事件。
另外，咱们还要注意领域事件的命名，如果套用英语的语法来说，一般是完成时 + 被动语态。比如说，订单已提交，这个“已”字就是完成时，代表已经发生的事情。而订单已提交也可以说成订单已“被”提交，实际是被动语态，只不过一般把被字给省掉了。
识别“项目管理”流程的领域事件
接下来咱们一个一个业务流程来做。至于具体先做哪个流程，并没有特别的规定。不过由于项目管理这个流程比较长，我们就拿这个流程为例来讲吧。
首先，咱们花十来分钟时间，各自按照自己的理解，把项目管理中发生的各个领域事件，分别写在橙色便利贴上。然后按大致的时间顺序贴在墙上。每人贴一行。写出来以后大概是下面这个样子：

然后，就可以对比咱们两个人写得有什么不一样，再经过讨论得出一致的结果。现在，咱们从左到右看一下。
第一步就发现了一个小区别。你写的是“客户已创建”，我写的是“客户已添加”。

那么你就会问我：“业务人员一般会说客户已创建还是客户已添加呢？”
我告诉你：“一般是说客户已添加，因为从业务的角度，客户本来就是存在的 ，不需要创建，只是把客户资料添加到我们的系统而已”。你表示同意。
然后我又叮嘱了一下：“以后添加客户的时候，都说添加这个词，别再说创建了。”这时候，其实我们已经是在建立“统一语言”了。统一后的结果是下面这个样子：

第二步，你写的是“签订合同”，我写的是“合同已签订”。

一说你马上就反应过来了，刚才我们说过要用完成时和被动语态，“签订合同”是个动作，不是事件。所以达成一致后，结果变成下面这样：

下一步，你写的是“项目已创建”，我写的是“合同已生效”。不过我后面还有一步“立项”，应该和你的“项目已创建”是一回事，所以说明我比你多了一步“合同已生效”。

于是你又问了：“合同签订以后不是马上就生效了吗，还要有一个额外的生效步骤吗？”
我解释说：“合同签订的时候未必马上生效，比如 1 月 1 日签了合同，但合同中可以约定，真正生效是在 2 月 1 日，所以需要一个单独的步骤让合同生效。”这时候，你知道了一条原来不知道的领域知识。
然后你又问了：“我写了项目已创建，但是你写的是已立项，你这种写法好像和其他的不太一致呀。”
我解释说：“虽然我们为领域事件命名的时候，常常用‘什么什么已什么什么’的形式，不过如果业务上已经有约定俗成的术语，我们就直接使用术语，这样更容易和业务沟通。现在业务觉得已立项是一个通用的术语，写成项目已创建反而显得生硬。”
现在你又知道了，在 DDD 中的各种命名，一般都优先使用约定俗成的业务术语。统一后的样子如下图：

再来看后面三步，这时我发现自己漏写了“项目已启动”。然后我们再比较了一下“项目已终止”和“项目已结束”两个说法，觉得“项目已结束”更符合业务术语。而“合同已结束”这一步，咱们俩是一样的。

不过我在“项目已结束”前面还多了一个“员工已分配”。

于是你又问我：“刚才你讲需求的时候，好像是把员工分配作为一块单独的需求来讲的，不属于项目管理这个流程吧？”
我想了想，说：“员工分配背后的业务逻辑有点复杂，所以之前单独拿出来讲，其实员工分配是项目运作中的一个重要环节，放在项目管理中也没毛病。”你对此表示认可。
这时我又补充了一点：“员工分配到项目的时候，要填入预计的投入工作量的百分比，一个人可以同时上多个项目，但预计的投入百分比总和不能超过 100%。这种逻辑一般叫业务规则，为了避免忘记，咱们也写在便利贴上吧。”
于是我们把业务规则写在浅灰色便利贴上，贴在“员工已分配”事件的下方。经过这几步，结果变成了下面这个样子：

再下一步，你多了一个“客户已终止”。

我解释说：“客户可以在系统中长期存在，以便不断挖掘商机，一般不必专门进行终止。理论上说，万一客户破产了，是应该终止，不过目前业务上还没有这个需求，这一点可以以后再考虑。”于是我们把“客户已终止”拿掉了。
然后你又发现，我的流程中最后还多了一个“客户经理已更换”。

你有点惊讶地问：“可以更换客户经理吗？你刚才好像没说呀。”
我说：“可以更换，我刚才忘记说了。”
你紧跟着追问：“那么负责合同的销售人员，还有项目经理是不是也可以换呢？”
我说：“也可以，我自己都忘了写了。”
于是我们补充了这几个事件。同时，由于这三个领域事件不一定会出现，所以我们决定另起一行，也就是第一行表示主流程，包括必然发生的事件，第二行表示可选的事件。现在统一后，就变成了下面这个样子：

最后，我们把整个流程又仔细检查了一遍。你眼尖，又发现了一个遗漏的领域事件。员工分配到项目上以后，还可以下项目，所以应该有一个“员工已退出”事件。
好补充以后，最终结果就是下面这个样子：

现在，我们终于为项目管理流程，完成了“识别领域事件”这个步骤。
识别其他流程的领域事件
用同样的方法，可以识别其他流程的领域事件，这里就不一一重复了。下面这张图是我们识别出的所有领域事件：

在这张图里，你可以看到，有些业务规则在最开始的需求描述里是没有说明的，而是在咱们不断地讨论中，逐步澄清的。此外，我们还用橘红色的便利贴表示业务流程的名字，以便区分。
关于领域事件，我们还要注意下面这两点。
第一，不要把技术事件当成领域事件。领域事件一定要是领域专家所关注的，用的是业务术语。像数据库事务已回滚、缓存已命中之类的技术术语，不是领域事件，不在这个阶段讨论。
第二，查询功能不算领域事件。领域事件应该是对某样事物产生了影响，并被记录的事情。一般是某个事物的创建、修改和删除。还有一种情况是向其他人或者系统发消息，例如“通知邮件已发送”也算领域事件，因为接收方可能会通过进一步处理来影响某些事物。
而像“客户信息已查询”这些就不算领域事件，因为还没有对事物产生实际影响。不过，这并不代表查询功能不重要，查询功能也要以某种方式体现。这一点在后续的课程我们再讲。
到这里，我们就完成了事件风暴的第一步“识别领域事件”，后面两步“识别命令”和识别“领域名词”将在下一节课讲解。
总结
下面我们来总结一下。这节课，我们首先解释了用事件风暴之类的方法梳理需求的必要性，包括从头脑中挖掘需求、补充遗漏的需求、使业务人员和技术人员理解一致，以及辅助识别领域对象四点。
事件风暴是从识别领域事件开始的。“领域事件”是在业务过程中，业务人员关注的那些已经发生的事情。技术事件和查询功能都不算领域事件。领域事件意味着业务流程中每个步骤的结果。这种结果导向的思维方式更容易理清业务。事件风暴中的“事件”两个字就来源于领域事件。
识别领域事件的过程可以分成了两大步：第一步是参加的人，各自写出领域事件；第二步是一起讨论，统一理解。这种先发散，后收敛，反复迭代的过程实际上就是一种头脑风暴。
头脑风暴是一种常见的协作方式，可以让一群人一起通过思维的碰撞，分析问题，最终达成一致。事件风暴中“风暴”两个字就来源于“头脑风暴”。
在这个过程里，我们已经开始形成统一语言。所谓统一语言，英文是 Ubiquitous Language，是 DDD 中的一个核心模式。指的是业务人员和开发人员使用的语言要一致。语言是知识的载体。语言一致就意味着背后对领域知识的理解一致。统一语言贯穿了 DDD 的全过程。
同时，我们也开始识别业务规则。业务规则的处理，也会在后面继续讨论。
我们这节课不厌其烦地讲了识别领域事件的整个过程，是希望你能够体会到在真实的场景中，我们怎么通过不断地讨论，澄清误解、补充遗漏、发现业务规则。
一定要注意，“协作”才是事件风暴的精髓，而具体结果怎样呈现，反而是第二位的。当然，最好的学习方法不是听课，而是实践。所以呢，赶快找几个小伙伴，拿你手头的项目试一试，真正体会一下协作共创的乐趣。
思考题
1. 今天识别的领域事件，主要是以“增加”的功能为主，你觉得需要把修改和删除的功能都列出来吗？
2. 业务规则用便利贴写出来，时间久了可能不容易维护，你觉得有没有更好的办法呢？
好，今天的课程结束了，有什么问题欢迎在评论区留言。下一节课，我们继续完成事件风暴的另外两个步骤：识别命令和识别领域名词，为领域建模打下基础。

   
04｜事件风暴（下）：事件风暴还有哪些诀窍？
钟敬 2022-12-13



1.0x

讲述：钟敬大小：16.25M时长：17:48
你好，我是钟敬。
上节课我们完成了事件风暴的第一步，识别领域事件。
领域事件表示的是每个业务步骤的结果。那么我们再往深想一步，到底是什么人，执行了什么操作才会造成这种结果的呢？另外，识别行为需求以后，又该怎么进一步导出领域模型呢？
为了解决这些问题，这节课里，我们来一起完成事件风暴的另外两步，识别命令和识别领域名词。
把事件风暴的三步都搞清楚后，我们再来归纳一下事件风暴的作用以及实操时候的一些常见的问题。
事件风暴第二步：识别命令
现在，我们开始进行第二步，识别命令。
所谓命令（command），就是引发领域事件的操作，我们可以通过分析领域事件得到。除了识别出命令本身以外，我们通常还要识别出谁执行的命令，以及为了执行命令我们要查询出什么数据。
比如说，对于“合同已签订”这个事件，对应的命令就是“签订合同”。这里，我们在水蓝色的便利贴上写出命令，然后贴在对应的领域事件上方。如下图：

那么“签订合同”这个操作是什么人执行的呢？需求里说是“销售人员”。这里的销售人员术语上叫做“执行者”，英文是 actor。我们把执行者写在小一点的粉色便利贴上，贴在命令上方，如下图：

为了表示执行者是人，这里还在便利贴上画了一个小人儿。之所以这样，是因为有时执行者还可以是系统，可以在便利贴上画一个屏幕的图像表示系统执行者。像下图这样：

这里还有一个问题，在执行“签订合同”操作时，执行者要先从系统里查出客户信息，才能和这个客户签订合同。这里，“客户”是一种“查询数据”。我们把查询数据写在小一点的绿色便利贴上，也贴在命令上方，如下图：

这样，一个命令的所有信息就识别完了。现在，假设我们按照前面的方法一边讨论，一边识别出所有的命令，结果就是后面这个样子。

关于这个图，我们还要再补充说明几点。
首先，有些命令可能没有查询数据。比如添加客户，从需求来看，添加客户时不需要查询出什么其他信息，如下图：

其次，还有的命令会有多个查询数据。比如说为项目分配员工，要查出项目和员工两个信息，如下图：

另外，还有的命令会有多个执行者。例如更换客户经理，既可以由客户经理把自己的客户转给另一个客户经理，也可以由客户经理的上级来操作，这时就可以有不止一个执行者了，如下图：

看到这里，你可能会提出疑问：“客户经理上级”这个执行者含义好像有些模糊呀？比如说，客户经理的上级还是客户经理吗？对于这个问题，我表示一时也没想清楚，可以先这么写，留到进一步做领域建模时再澄清。
还有最后一点你要注意，执行者是某个角色，而不是具体的人。例如“张大文”是一个客户经理，这时在便利贴上写的是“客户经理”这个角色，而不能是张大文这个具体的人。
事件风暴第三步：识别领域名词
识别完命令，我们来做第三步，识别领域名词。
这里说的领域名词，是从命令、领域事件、执行者、查询数据里找到的名词性概念。例如，对于签订合同这个命令而言，受到影响的名词性概念是“合同”；类似地，对于合同已签订这个领域事件，是由于“合同”这个名词性概念的状态变化所导致的。
识别领域名词的操作步骤可以分成两小步。
第一步，我们要挪动上一步的便利贴，把围绕同一个名词的命令、事件、执行者、查询数据摆在一起，分成好几“堆”，贴在墙上。下图是其中一部分：

第二步，把领域名词写在大一点的黄色便利贴上，贴在每堆便利贴的中间，如下图：

所有领域名词都识别出来后，就是下面这个样子：


让咱们再仔细看看这张图。
首先我们发现，“为项目分配员工”和“员工已分配”出现了两次，一次是关于“员工”的，另一次是关于“项目”的。
因为这对命令和事件是关于两个名词的，所以我们抄写了两遍。其中你可以看到，关于项目的那次，我在命令和事件后面加了一个 “2” ，就是同一个概念在图中出现了第二次的意思，这是我们画图时的一个常用技巧，其他有 “2” 的命令和事件也是同理。

另外，我们还看到，“企业”这个名词只和“企业”这个查询数据有关，但是没有“添加企业”之类的命令。
咱们俩讨论了一下，认为租户和企业是一回事，添加了租户，自然就添加了企业，所以目前这样好像没毛病。那就先这样吧，如果还有问题的话，等到领域建模的时候再澄清。

类似地，管理人员和人事人员也只和执行者相关，而没有相应的命令。这些我们都可以留到领域建模的时候再进一步想清楚。

现在，我们就完成了事件风暴的所有步骤，后面就可以用这个为基础进行领域建模了。
再谈事件风暴的作用
在进行后续的工作之前，咱们还是来归纳一下事件风暴的作用，进一步加深理解。
上一节课我们已经说过，事件风暴是业务人员和技术人员一起协作，捕获行为需求、消化领域知识、形成统一语言的一种方法。这是就整体来说的。
现在我们已经一起做了一场事件风暴了，咱们可以结合这两节课的学习，再体会一下每个要素在建模和实现层面更具体的用处。
首先我们看看领域事件的作用。从代码实现的角度来看，领域事件一般会对应一段代码逻辑，这段逻辑可能会最终改变数据库中的数据。另外，在事件驱动的架构中，一个领域事件可能会表现为一个向外部发送的异步消息。
那命令的作用体现在哪儿呢？领域建模时，我们可以通过对命令的走查（walkthrough），细化和验证领域模型。在实现层面，一个命令可能对应前端的一个操作，例如按下按钮；对于后端而言，一个命令可能对应一个 API。
再来说命令的执行者。在领域建模时，执行者可能本身就是一个领域对象，也可能是领域对象充当的角色，或者是权限管理中的一个角色。
至于查询数据，我们上一讲说过，查询功能不产生领域事件，因此也不会有相应的命令。那么怎样保证查询功能不被遗漏呢？
实际上，每个查询数据，就对应着一个查询功能。不过，这里的查询数据是为了某个命令服务的。系统中可能还有一些单纯的查询功能，并不与某个特定的命令绑定。这些查询功能不会通过事件风暴识别出来，需要单独进行分析。
最后，我们再看看领域名词的作用。其实识别领域名词的最终目的是要找到领域模型中的对象。那么为什么我们不把这一步直接叫做识别领域对象呢？
这是因为，在这一步里识别出的名词，虽然很可能就是领域对象，但也未必。一个名词有可能只是一个对象充当的角色，或者对象的属性，还有些名词需要经过合并或拆解后，才是合理的领域对象，而这些需要等到领域建模时才能真正搞清楚。
事件风暴本身并不是进行这种深入分析的合适工具，所以，我们在这一步只需要识别出领域名词就可以了，这些名词将成为领域建模的“素材”。
事件风暴的常见问题
好，聊完事件风暴的作用，我们再谈谈实践中常常遇到的一些问题。
第一个问题是，在事件风暴里是否要列出所有的领域事件和命令？
你可能已经发现，在我们现在做的事件风暴里，其实只列出了部分领域事件和命令。例如，有签订合同这个命令，但没有修改合同和删除合同，但修改和删除功能应该也是系统中必要的呀。
其实，列出所有领域事件和命令并没有原则上的错误，但这样做会让结果变得繁琐，反而让人抓不住重点。
所以我的建议是：在事件风暴里只列出主要的、足以用于表达和交流领域知识的步骤，例如签订合同、生效合同等等。而像修改合同和删除合同这样的步骤是显而易见的，在讨论过程中可以提一下，但不必真的列出来，这样是为了保持简洁。
那么不列出来，怎么保证这些功能不被遗漏呢？我们可以结合用户故事或者传统的功能列表等方法保存系统功能的全集，这样就能解决了。
第二个问题是，各个领域事件需要体现严格的时间顺序吗？
在上一讲我们说过，只需要按照大致的顺序，贴出领域事件就可以了。这是因为，如果要体现严格的时间顺序，需要用到更复杂的符号，例如条件判断，还有要画更多的连线，这会使事件风暴变得非常繁琐。
因此，我们应该关注点分离。如果要体现严格的时间顺序，我们可以用流程图、用顺序图等方法，但事件风暴不必关注这一点。
第三个问题是，每个步骤的颗粒度应该有多大？
这里说的步骤，指的是一对领域事件和命令。
比如说，“签订合同”这个命令，在具体操作的时候，可能分成录入合同基本信息、录入合同明细、上传附件等等更小的步骤。那么，我们需要为每一个小步骤都识别出领域事件和命令吗？
这就要考虑从业务的角度，我们是把每个小步骤都当作独立的一个事务来看待，还是把它们合起来作为同一个事务。
另外，可以设想，如果每个小步骤都向外界发出一个领域事件，对系统后续的功能是不是有意义。那么在目前的需求里，合同作为一个整体来提交就可以了，分成小的领域事件，并没有意义，所以不再分成更小的步骤了。
在实践里，有时仍然会有模棱两可的情况，这时，原则上宜粗不宜细。可以先采用比较大的颗粒度。后面必要的时候，再拆细，就可以了。
第四个问题是，事件风暴适用于所有项目吗？
这个问题可以从两个层面回答。第一个层面，事件风暴主要应用在需求不清晰，或者理解不统一的情况下，通过协作的方式理清业务、达成一致，所以通常对于新项目比较适用。
至于遗留系统改造的情况，如果这个系统的知识已经流失得很严重，那么事件风暴仍然是有意义的。但如果大家对这个系统的业务知识很清楚，只是要进行架构改造，那么事件风暴的意义就不大了。
第二个层面，即便在适用的场合，事件风暴也不是唯一的方法，我们还可以用用例分析、用户故事等方法实现类似的目的。只要抓住协作、统一语言等等要点，这些方法都可以用在 DDD 的项目里。
所以，如果你的项目里还没有正规的、令人满意的捕获行为需求方法，那就可以使用事件风暴。如果已经有了成熟的方法，你可以借鉴事件风暴的思路，在原来的方法里加入协作、统一语言、识别领域名词的实践，也能达到同样的效果。
第五个问题是，怎么保存和维护事件风暴的结果？
到现在为止，事件风暴的结果都是贴在便利贴上的，显然不容易长期保存。一般来说，我们可以在事件风暴的过程中专门安排一个记录员，由他使用 PPT 之类的画图工具，把贴在纸上的内容重新画一遍，就可以实现电子化的保存了。
还有一个更深入的问题是，事件风暴是不是需要长期维护和更新？还是说我们只是把事件风暴当作一次性的步骤，不必长期维护？
通常，如果事件风暴的内容最终会反映到用户故事、用例、功能列表等产出物中，而这些产出物会进行维护，那我们就不必专门更新事件风暴的产出物了，只在需要的时候作为一种沟通工具，将电子化的结果作为一种中间产物保存就可以了。
但是，如果你的团队并没有用户故事和用例等保存行为需求的方式，那么我建议你对事件风暴进行维护和更新。
除了绘图之外，事件风暴也可以用表格的形式来保存，你可以参考一下后面的表格。

不过，这个表里的领域对象需要在领域建模阶段才能分析清楚，这里先空着，到时再回填。
最后一个问题是，怎么保存领域规则？
领域规则是重要的领域知识，必须妥善保存。在事件风暴的过程里我们已经识别出了一些领域规则，在后续的领域建模阶段，可能还会识别出更多。如果只是写在便利贴上，或者画在图上，时间长了，就很难维护了。
所以，我们要编一个领域规则表，把所有的领域规则都汇总在里面，然后再把领域规则表和领域模型放在一起，作为领域知识的重要组成部分，后面就是一个例子。

在这张表里，你还看到了一个“模块”列，这个概念我们会在以后的课程再讲。
总结
现在，我们对这两节关于事件风暴的课程做一个总结。
事件风暴是一种通过协作的方式捕获行为需求的方法，在这个过程里，业务人员和技术人员一起消化领域知识、形成统一语言、并为领域建模奠定基础。
事件风暴分为识别领域事件、识别命令、识别领域名词三个步骤。这一节课讲的是后面两个步骤。
“命令”是引发领域事件的操作，可以从领域事件“反推”出来。此外，还可以识别命令的两个附加信息，一个是发出命令的“执行者”，另一个是为了完成命令要查询出的数据。
“领域名词”是隐含在命令和领域事件中的名词性概念。这些名词是领域建模的素材, 而对于这些素材的深入分析可以留到领域建模进行。
在这三个步骤中我们还看到，有一些遗留问题还没得到很好地处理。这是因为事件风暴的能力还不足以分析一些更加深入细致的问题，这些可以等到领域建模的时候再解决。也就是说，领域建模具有“兜底”的作用。
此外，我们在这一讲还讨论了事件风暴中各个要素的作用，也分析了几个实践中常见的问题，你可以再着重看一看。
思考题
最后，给你留两道思考题。
1. 如果你以前学习过用例分析、用户故事等方法，那么比较一下，看它们和事件风暴各自有什么优缺点？
2. 如果你自己的项目中，已经有捕获行为需求的方法，那么怎样借鉴事件风暴的思路，为现有的方法添加协作和统一语言的实践？
好，今天的课就结束了，有什么问题欢迎在评论区留言，下节课，我们一起实践 DDD 的核心部分——领域建模。


05｜领域建模实践（上）：怎样既准确又深刻地理解业务知识？
钟敬 2022-12-15



1.0x

讲述：钟敬大小：17.75M时长：19:26
你好，我是钟敬。
上节课咱们完成了事件风暴，梳理了系统的行为需求。但你可能也发现了，其实还有些微妙的业务概念还没有澄清，这就要靠领域建模来完成了。
建立领域模型是 DDD 的核心。要建好领域建模，需要理论和实践相结合。由于我们的模型有一定的复杂性，所以我把领域建模的实践分成两节课。完成实践以后，我们会再用一节课，从理论层面让你进一步深化对领域建模的理解。
今天这节课，我们先通过租户、组织和员工这几个部分学会基础的建模方法。
领域建模中的一些基本概念
我们先来理清领域建模中的一些基本概念，方便你理解下面的建模实践。领域建模主要有两个目的：
将知识可视化，准确、深刻地反映领域知识，并且在业务和技术人员之间达成一致；
指导系统的设计和编码，也就是说，领域模型应该能够比较容易地转化成数据库模式和代码实现。
而我们建立领域模型，主要是要识别领域对象（domain object），领域对象之间的关系，以及领域对象的关键属性，必要的时候还要将领域对象组织成模块。当然了，还有一些比较深入的内容，我们会在迭代二中再讲。
那么，什么是领域对象呢？我们系统中要处理的各种“事物”就是领域对象。比如说项目、员工、账户等等。这些对象都反映了名词性的概念。
其中，有些名词化了的动词也是领域对象。比如说我们进行了一笔支付操作，并且想把这笔操作记录下来。这时，“支付”也是领域对象。支付本来是动词，但这里实际上是要把一笔支付的信息记录下来，在这里就把“支付”当名词用了。
领域模型是用领域模型图来表达的，通常用 UML 来画。UML 是“统一建模语言”的意思，英文是 Unified Modeling Language，是面向对象建模的国际标准。其中，领域对象用下面这个符号来表示：

这个符号表示“员工”对象。其中第一栏是领域对象的名称，第二栏列出了对象的属性（attribute），姓名、性别都是员工的属性。
严格地说，在 UML 中，这个符号叫做“类”（class）。比如说，张三是员工，李四也是员工，我们可以说，员工指一类事物。这时我们可以用 UML 中的术语说，员工是领域对象的一个类，张三和李四是这个类的实例。在领域建模过程中，我们说领域对象时，有时指类，有时指实例，一般可以通过上下文来区分。
此外，DDD 中将领域对象又分成实体（entity）和值对象（value object）。值对象我们等到第二个迭代再讲，这个迭代我们只关心实体。我们前面说的“员工”“账户”等都是实体。
由类和他们之间的关系组成的图叫做类图，这也是领域建模里用到的最主要的图。
下面我们就开始通过画类图的方式进行领域建模。同样，你扮演架构师，我扮演产品经理。
初步识别实体
我们可以从上节课中识别的领域名词入手，分成几部分来建模。我们先考虑租户、组织和人员。上节课的图是这样的：

首先，你可以先假定每个领域名词都是一个实体，把它们用类的符号画出来。如下图：

这就可以算作一张最简单的类图了。你可能注意到了，这里并没有写属性。其实，在领域建模阶段，我们主要关注的是实体和它们之间的关系。如果实体的名字已经能清晰说明实体的含义，那我们就不需要加属性了。如果名字还不足以充分表达含义，我们可以写几个关键属性，来辅助说明。
另外要注意，我们这里只是简单粗暴地假定了领域名词就是实体。通过后面的分析，我们还会发现，有些名词不是实体，有些要转换成其他形式。
识别“一对一”关联
现在，我们来识别实体之间的关系。先来看看租户和企业。
首先，你问我：“租户和企业这两个概念有没有关系呢？”我回答说：“肯定是有关系的。”于是你可以在它们两个之间画一条线，表示它们之间有关系。

然后，你又问了我两个有关业务的问题。第一个问题是：“一个租户最多可以对应几个企业？”我回答说：“只能对应一个企业。”于是，你在企业那一端写了一个 “1” 来表示。

然后你反过来问第二个问题：“一个企业可以作为几个租户？”我回答说：“一个企业也只能作为一个租户。”于是你在另一边也写上 “1” 。

这时，我们可以说，租户和企业具有一对一的关系。
这里的两个 “1” ，在 UML 中称为多重性（multiplicity）。那么，这种关系整体上呢，在 UML 的术语里叫做“关联”（association）。后面我们都用这种严格的说法，说成一对一关联。
这时你可能又想到了一个问题：“为什么不把租户和企业合并成一个概念呢？”
在有些情况下，一对一的两个实体确实是可以合并的。这取决于这两个概念的关注点是否相同。
但在我们的需求里，租户关注的是客户和提供云应用的供应商之间的协议，背后隐含的需求可能是云平台要为这个客户分配多少硬件资源、怎样收费、提供哪个级别的备份等需求。假如这不是一个基于 SaaS 的应用，根本不会有租户的概念。
而另一方面，企业是组织结构管理中的一个概念，即使不基于 SaaS，企业这个概念也存在。所以这是两个不同关注点的概念，不应该合并。
识别“一对多”关联
下面我们再分析企业和开发中心的关联关系。这时你同样考虑了两个问题。首先，一个开发中心可以属于多少个企业呢？只能属于一个企业。这和上面的画法相同。

第二个问题是，一个企业可以有多少个开发中心？答案是可以有很多个。这可以在开发中心一端写一个 “*” 来表达。

这时，我们可以说，企业和开发中心具有一对多关联。
接着你用同样的方法画出了开发组，如下图：

现在咱们来考虑部门。你可能会发现，部门这个词其实用得不太准确，因为开发组也可以认为是部门。其实按照这里的需求我们想表达的是财务部、人事部等区别于开发中心和开发组的部门。
然后你又问我了：“在业务上，怎么称呼这种区别于开发中心的部门呢？”我说：“业务上一般叫做直属部门。”于是你在图中增加了直属部门。

然后，你把员工也加上了。

就这个图的含义而言，一个员工可以属于开发组，也可以属于直属部门，好像已经满足了需求，但是仔细想一下，你可能就会发现两个问题。
第一个问题是，如果将来组织层级发生变化，比如说在开发中心和开发组之间又增加了一层开发团队；或者有些开发组不属于任何开发中心，而是直属企业，那么这个模型就要修改了。也就是说，这个模型不容易适应组织层级的变化。
第二个问题是，一个员工其实可以不属于开发组，而只属于开发中心，比如开发中心的主管就是这样。同理，企业总经理也只属于企业本身而不属于任何下属部门。那么为了表达这种关系，我们就要再增加两条表示关联的线。

线越多，图就越杂乱。也就是说，这个模型不够简洁。
那么怎么解决这两个问题呢？我们要对这个模型进行抽象。
进行抽象
你可能已经注意到了，企业、开发中心、开发组、直属部门，其实都是组织结构中的节点而已，从这一点来说，他们是有共性的。
于是，你问我：“既然它们有共性，能否起一个统一的名字呢？也就是说，企业、开发中心、开发组、直属部门，可以统称为什么呢？”我回答说：“在业务上可以统称为组织。”所以你把模型改成下面这个样子：

由于开发中心、开发组等都是组织，所以只画出组织就可以了，模型图变得很简洁。但是你马上就发现，无法区分出一个组织到底是开发组还是开发中心了，也就是归纳了共性，但个性却丢了。
这时你问我：“一个组织是开发中心，另一个是开发组，那么在业务术语上可以说，这两个组织具有不同的‘什么’呢？”我告诉你：“可以说，这两个组织具有不同的组织类别。”
于是你画出下面的模型图。

也就是在这个模型中增加了一个组织类别的实体。企业、开发中心、直属部门等都是组织类别的实例。一个组织类别下可以有多个组织，而一个组织只能属于一个组织类别。比如说，开发组这个组织类别，下面可以有开发一组、开发二组等等很多具体的组织。
为了怕以后读这个模型图的人不理解什么是组织类别，我们还可以加一个注释，用来举例说明有哪些组织类别。在 UML 中，注释用折角的矩形表示，和被注释的实体之间用虚线连接，如下图：

识别“自关联”
然后，你又发现，这个图还不能表示企业、开发中心、开发组等之间的上下级关系。这可以用组织这个实体上的“自关联”来表达。画出来是下面这个样子：

在这个图中，组织实体上有一个自己到自己的一对多关联。这个关联翻译成自然语言可以这么说：一个组织可以有多个组织作为自己的下级；而一个组织只能有一个组织作为自己的上级。这样就表现出了上下级的层级关系。这种一对多的自关联，实际上表达的是一种树形结构。
另外，在这个自关联的两端，有上级和下级两个词。它们在 UML 里称为“角色”（role）。也就是说，在这个关联的 “1” 端的组织充当上级这个角色，在另一端充当下级角色。如果没有这两个角色名称的话，我们就不知道是一个上级有多个下级，还是一个下级有多个上级了。
增加“约束”
另外，为了说明“一个开发中心下面有多个开发组，而不是一个开发组下面有多个开发中心”这个业务规则，我又另外加了一个注释。如下图：

你可能发现了，这个注释和上一个有些区别，它的内容用大括号括起来了。在 UML 中，用大括号括起来的内容称为“约束”（constraint）。和一般性的注释不同，凡是约束，必须在程序中的某个地方进行实现。约束也是一种业务规则，应该加进前面讲过的业务规则表。
不过，细心的你又发现，关于租户还有两个问题没有在这个模型中表达出来。
第一个问题是，没有说明“只有企业才能作为租户，其他类别的组织不能作为租户”；另一个问题是，作为多租户系统，其实每一个实体都应该与租户有一个关联，说明这个实体是属于哪一个租户的，这样才能把不同租户的数据区分开。但是，如果把这些关联都画出来，模型图中的线条就会太多了，变得非常混乱。
于是，你又添加了一个注释和一个约束来说明上面两个问题。有了这个注释，租户和组织上原来的那个关联也可以省去了。如下图：

你看，这个模型既简洁又灵活，解决了我们前面说的员工实体上有多个关联以及组织层级难以扩展这两个问题。
识别“多对多”关联

你问我：“管理员和人事人员其实也是员工是吧？”我说：“是。”但这时你可能会纠结，这两个东西到底是不是实体呢？
于是你又问我：“从业务的角度，可不可以认为管理员和人事人员其实都是员工担任的岗位呢？”我说：“这个理解很正确。”于是，你就画出了下面的图：

这个图表示，一个员工可以担任多个岗位，而一个岗位也可以有多个员工担任。员工和岗位之间是“多对多”关联。我表示，这完全符合我对业务的理解。
更丰富的“多重性”
现在，我们再看一下多重性问题。前面说过，关联两端的 “1” 或者 “*” 称为“多重性”。比如说下图中组织和员工之间就是一对多关联：

你还可以问两个问题，把多重性进一步细化。
第一个问题是：“一个组织可以没有任何员工吗？”我回答：“业务上允许先建立一个组织，但暂时不往里面分配任何员工。”那么，你可以在员工那一端的 “*” 前面加上 “0..”，变成 “0..*” 。如下图：

这里的 “0..*” 我们也可以这样理解：一个组织最少有 0 个员工，最多可以有很多员工。
类似地，你可以从关联的另一个方向再问第二个问题：“一个员工可以不属于任何组织吗？”我回答：“不行。一个员工必须属于一个组织。”于是，你把另一端改成了 “1..1” 。

这里的 “1..1” 表示，一个员工最少要属于一个组织，最多也只能属于一个组织。
通过上面的方法，多重性的语义就变得更加丰富了。在实际项目中，团队可以自行决定，把多重性识别得粗一点，只写 “1”和 “*” ；还是细一点，识别出 “1..1” “0..*” 等等。一般来说，如果目的是在短时间内大致了解业务概念，就可以做粗一点；如果是为了指导具体的开发，则可以做细一点。在后面的例子中，我们都按照比较细的方法来做。
丰富了多重性以后，整个模型成为了下面的样子：

现在，我们终于完成了关于租户、组织和员工的领域模型。这节课就先到这，我们下节课再完成领域模型的其他部分。
总结
下面我们总结一下这节课的内容。
我们今天首先解释了用于领域建模的几个基本概念，包括 UML、领域对象（domain object）、实体（entity）、类（class）、实例（instance）等。
然后我们从事件风暴识别出的领域名词出发，开始进行领域建模。首先假定每个领域名词都是一个实体。然后识别实体之间的关联。关联可以分为三种：一对一、一对多和多对多。而这些不同的关联，可以用多重性来表达。
假设有 A 和 B 两类实体，你可以通过问四个问题，来把多重性搞清楚：
一个实体 A 最多可以对应多少个实体 B？
一个实体 A 最少可以对应多少个实体 B？
一个实体 B 最多可以对应多少个实体 A？
一个实体 B 最少可以对应多少个实体 A？
这些问题看起来很“机械”，但对于初学者来说，关联关系是非常容易搞错的。所以如果你还不是很熟练的话，建议你老老实实地问自己这四个问题，一边问，一边把多重性写出来，这样可以保证不出错。
还有一种关联是实体自身上的“自关联”，可以表达由某种实体组成的树状或网状结构。这比一般的关联稍微难理解一些，但熟练以后就容易了。
在建模过程中，我们还可以通过“抽象”，找出领域名词中并没有直接揭示出来的实体。例如把企业、开发中心等抽象成组织和组织类别，把管理员、人事人员等抽象成岗位。这样的模型更能反映出业务的本质，从而更加灵活。通过这种抽象的过程，使模型和业务不仅仅是“形似”，更是“神似”。
我们还可以通过增加注释和约束，使模型中的业务知识更加丰富和准确。其中，约束是一种特殊的注释，它的内容必须以某种形式在代码或数据库中实现。约束也属于我们在之前说的业务规则，需要补充到业务规则表中去。
思考题
1. 为什么领域建模要由业务人员和技术人员一起协作完成呢？
2. 通过抽象思维，可以抓住需求的本质，达到“神似”，你可以在遇到过的实际项目中，举出类似的例子吗？
好，今天的课程结束了，有什么问题欢迎在评论区留言，下节课，我们继续进行领域建模的实践。



  
06｜领域建模实践（下）：领域建模还有什么其他技巧？
钟敬 2022-12-17



1.0x

讲述：钟敬大小：13.39M时长：14:40
你好，我是钟敬。
上节课咱们介绍了领域建模的一些概念，也一起完成了有关租户、组织和员工的领域建模。今天这一讲，我们继续对项目管理、人员分配和工时登记部分进行建模。
在完成领域模型的过程中，我们还会对“多对多关联”进行更深入的学习，一起识别“操作”，并且划分模块，最后还会完善业务规则并建立词汇表。掌握了这些技巧，你就可以尝试运用领域建模解决一些实际问题了。
深入理解“多对多”关联
和上节课一样，我们从项目管理部分的领域名词开始建模。同样，你是架构师，我是产品经理。

我们先假定每个名词都是一个实体，然后再把这些实体一个个加到已有的模型图里。初步识别出的实体有下面这些：

处理“客户”
我们首先来处理客户实体。按照需求，每个客户有一个客户经理负责。你和我确认了一下：“客户经理也是员工对吧？”我说：“是的。”于是你把客户添加到了模型里，如下图：

这里你把客户经理当作了一个角色，员工和客户的关联翻译成自然语言就是“一个员工可以充当多个客户的客户经理，而一个客户有且仅有一个员工作为他的客户经理”。
处理“合同”
完成了对客户的建模，我们开始处理合同实体。根据需求，“每个合同都有一个销售人员负责”，于是，你画出了下面的模型图：

你有些疑惑：“客户经理是不是也是销售人员呢？”我说：“是的。”于是你意识到：“销售人员应该也是员工的一种岗位，并且在与客户的关联中，充当了客户经理这个角色。那么，类似地，销售人员又充当合同的什么角色呢？”我说：“就叫合同经理吧。”
于是，你修改了销售人员这个角色的名字，并且在岗位的注释中增加了销售人员。此外，你又增加了“只有销售人员才能作客户经理” 以及“只有销售人员才能作合同经理”这两条业务规则。
现在的模型图如下：

处理“项目”
接着，你又用类似的方法，增加了项目实体：

处理“为项目分配员工”
现在我们考虑“为项目分配员工”和“员工退出项目”这两个需求。
首先，我在图里面的员工和项目之间增加了一个表示“员工被分配到项目上”的关联，同时把“一个员工预计的投入百分比不能大于百分之百”的规则也标注出来。

这时候，员工和项目之间就有了两个不同的关联。原来那个一对多关联表达的是“员工充当项目经理”的关系。
另外，我们新增了一个关联，表示分配员工的关系。一个员工可以被分配到多个项目上，一个项目上又可以有多个员工，因此两者是“多对多”关联。在这个关联的员工一端，写上了项目成员这个角色。也就是员工充当了项目的项目成员。
在这里我们可以看到，两个实体之间，可以有多个关联。不同的关联代表不同含义，数量关系也可以不同，可以用角色名来区分。
然后你问我：“这里有一个关于投入百分比的规则，那么投入百分比这个属性应该记录在哪个实体上呢？”这时候我们发现了一个尴尬的问题，这个百分比既不能记录在员工实体上，也不能记录在项目实体上。
这是因为，只有员工和项目建立了项目成员这一关联的时候，记录投入百分比才是有意义的，也就是说，这个属性应该记录在这个多对多关联上。那么这在 UML 中怎么表达呢？
于是，我把模型改成了下面的样子：

这时候，原来的项目成员角色演变成了一个独立的实体，来表达员工和项目之间的多对多关联。预计投入百分比也就自然放在这个实体里面了。
注意，这时候，员工和项目成员之间的关联是一对多，项目和项目成员之间也是一对多。然后我总结道：“任何多对多关联，总能用类似的方法，通过引入一个表示关联的实体，拆成两个一对多的关联。”
接着，你又注意到一个问题，一个员工可以分配到一个项目上，然后退出项目，然后再一次分配到这个项目上，所以，我们就应该用时间段来记录员工参与项目的历史。
考虑到时间因素，有关投入百分比的业务规则可以进一步明确为“在任何时刻，一个人的预计投入百分比总和不能大于百分之百。”此外，从逻辑上，还可以识别一条规则一个员工在同一个项目上的时间段不能重叠。
于是你这样改进了模型：

处理“登记工时”
接下来，为了处理报工时的需求，你又增加了工时记录实体，以及相关的业务规则：

同样，我们可以把工时记录看作员工和项目之间的一种多对多关系。
识别“操作”
经过上面的梳理，我们已经把剩余的模型梳理得差不多了。但是，在事件风暴中咱们还遗留了一个问题：怎么处理客户经理上级、销售人员上级和项目经理上级这几个概念？现在看来，它们不太像是独立的实体，而更像是某种关系。
经过讨论我们发现，客户经理、销售人员、项目经理，无非都是员工，所以他们的上级，其实都可以归纳为取员工上级这个操作。然后我们讨论出了取员工上级的逻辑：
第一，如果员工不是所属组织的负责人，那么这个组织的负责人就是员工的上级；
第二，如果员工就是所属组织的负责人，那么这个组织的上级组织的负责人就是这个员工的上级。
你看，在上述逻辑中，我们又引入了一个组织负责人的概念。可以认为，负责人是员工在与组织的关联中充当的一种角色。
基于这些理解，我把模型进一步完善了一下：

在这个模型中，有几个要注意的地方：
第一，为了表达组织的负责人，我在员工和组织之间又增加了一个一对多关联，表示“一个员工可以不作任何组织的负责人，也可以作多个组织的负责人；而一个组织可以暂时没有负责人，但最多只能有一个负责人。”
现在，组织和员工之间就有两种不同的关联了，分别用了成员和负责人两种角色来区分。
第二，我们在员工实体上增加了取上级这个操作。操作（operation）在 UML 里也叫方法（method）。对象的属性是静态的值，而操作是动态的逻辑。在 UML 中，操作用“操作名 + 括号”的方式表示，括号中可以写参数。
第三，我们用一个注解说明了取上级这个操作的业务逻辑。
现在，我们的领域模型已经覆盖了事件风暴中发现的所有领域概念，但是，你是不是觉得这个图已经有点乱，不太容易理解了呢？
划分模块
之所以这个图不容易理解，是因为很多实体和关联混杂在一起，形成了一个“蜘蛛网”。但人的认知能力是有限的，面对这样一张复杂的对象网络，就产生了认知过载（cognitive overload）。
解决这一问题的方法就是“模块化”。也就是说，把模型中的业务概念组织成若干高内聚的模块（module），而模块之间尽量低耦合。
在 UML 中，可以用包来表示模块。包的符号是下面这样：

包的内部可以包含实体，也可以包含另外的包。在 UML 中，任何需要对元素进行分组的场合，都可以使用包。经过一番讨论，我们采用如下方式划分模块：

也就是说，我们把模型分成了 4 个模块，分别是租户管理、组织管理、项目管理和工时管理。是不是感觉清晰多了？
有了模块，我们就可以从两个层面理解模型。
第一个是宏观层面。宏观层面只关心模型中有哪些模块，以及模块间的依赖关系，不关心模块内部的细节。为了达到这个目的，我们可以画出更宏观的包图。像下面这样：

这里我们又引入了一个新的符号，就是带箭头的虚线。这在 UML 中表示依赖（dependency）关系，箭头由依赖方指向被依赖方。
从图中我们看到：
首先，所有模块都依赖租户管理。这是因为，为了将不同租户的数据区别开来，每个模块中的实体都要说明自己是哪个租户的；
其次，项目管理依赖组织管理。这是因为项目经理、项目成员等概念都依赖于组织管理中的员工；
还有，工时管理既依赖组织管理又依赖项目管理。这是因为工时管理要说明（组织管理中的）哪个员工在（项目管理中的）哪个项目上投入了多少工时。
我们要注意，依赖关系和前面讲的关联关系是不一样的。关联表示的是数据上的导航关系。例如，当我们说组织和员工之间具有一对多关联的时候，就意味着，由组织可以找到下面的员工，由员工也可以找到所属的组织。
依赖表示的意思更为广泛。如果 A、B 两个元素，有了 A 才能有 B，那么就可以说 B 依赖于 A。
我们可以认为关联是一种特殊的依赖关系，但依赖还有别的形式，比如说项目管理模块依赖于组织管理模块，两者之间未必有直接的数据导航关系，可能只是项目管理调用组织管理，获得需要的数据。
理解模型的第二个层面是微观层面，也就是深入到模块内部，了解实体和关联等等的细节。
通过这种分而治之的方法，我们可以在一定程度上管理复杂性，解决认知过载的问题。如果模型更加复杂，那么还要进一步采用限界上下文来处理，这个会在第三个迭代再介绍。
现在，领域模型基本完成了。为了完善开发过程，我们还要再进行两个实践：一个是完善业务规则，另一个是建立词汇表。
完善业务规则
我们在做事件风暴时就开始识别业务规则了，在领域建模中又识别出了更多的规则，所以现在我们需要把这些规则补充到业务规则表之中，如下表：

其中，从 R006 开始，是我们领域建模阶段新识别出的领域规则。
建立词汇表
接着我们来建立词汇表，也就是把事件风暴和领域模型中重要的词汇列成表。为什么要建立词汇表呢？主要是有两个作用。
首先，我们需要通过词汇表来规范领域模型中的词汇。同一个词，可能会在领域模型中出现多次，时间久了，就可能不一致，因此需要进一步规范。
第二，是可以用于后续编程中的命名。按照 DDD 的要求，程序中的各种命名也需要统一，并且需要与领域模型中保持一致。我们会在词汇表中列出英文全称和缩写，以达到这个目的。
词汇表是保证统一语言的重要手段。
目前为止的重要词汇，都列到下面这张词汇表里了。

总结
好，这节课的主要内容就讲完了，下面来总结一下。
今天我们在上节课的基础上，继续对项目管理和工时管理进行领域建模。在这个过程中进一步深化了对“多对多”关联的理解：我们可以通过引入一个表示关联的实体，将一个多对多关联拆成两个一对多关联。
我们还通过取员工上级的逻辑，学习了为实体添加操作。当模型变得比较复杂时，可以把模型划分成多个模块，使模型更容易理解。
在建立完领域模型之后，我们还进行了两项实践：完善业务规则和建立词汇表。很多朋友过去并不重视这两个实践，然而，它们对落实 DDD 实践，具有很重要的作用，一定要引起重视。
最后还要强调一点，领域建模易学难精，需要不断地练习才能熟练掌握。希望你能拿自己的实际项目练习一下。
思考题
1. 今天我们讲过，一个多对多关联可以拆成两个一对多关联，那么你觉得什么时候应该拆，什么时候不拆呢？
2. 客户经理是可以更换的，如果要保留更换历史，模型图应该怎样改呢？
好，今天的课程结束了，有什么问题欢迎在评论区留言。下节课，我们再从理论上深入理解一下“什么是模型”以及“什么是模型驱动设计”。

07｜领域建模原理：DDD领域建模和传统方法有什么区别？

你好，我是钟敬。
前面几节课，我们一起完成了行为需求和领域建模，重点在于实践。但是，如果仅停留在实践层面，不去了解背后的原理，我们就会知其然而不知其所以然，最终还是不能很好地进行实践。
所以，在对领域建模有了一定的感性认识以后，今天我们上升到理论层面，一起来理解模型驱动设计的本质含义。然后再来深入探讨“统一语言”，以及它和领域建模的关系。
什么是领域模型？
在讨论什么是领域模型之前，咱们先说说什么是模型。
先来看几个例子。比如说你去买房，售楼处都会有一个沙盘模型，这样你就可以看到楼的外观、朝向、周边环境等等。
但是如果要盖这个楼盘，靠沙盘模型就不行了，需要有一套详细的建筑图纸，图纸也是模型。为了对大楼进行设计，还要进行各种计算，计算用的公式也是模型，称为数学模型。另外，小孩玩的玩具车、玩具枪什么的，也是模型。事实上，现代生产和生活中，充满着各种各样的模型。
从这些例子里，咱们可以发现模型的几个共同特点。
首先，模型是以解决特定问题为目的的。例如沙盘模型是为了卖房，而建筑图纸是为了盖楼。没有目的就谈不上模型。
第二，模型都是对现实世界或人们思维中的事物进行的模拟。例如沙盘模型和建筑图纸都是对建筑物的模拟，而玩具车是对真车的模拟。
第三，模型总是提取了被模拟事物中的部分信息，而忽略掉了其他大部分信息。例如，沙盘模型提取了楼盘的外观信息，但是忽略了内部结构和建筑材料信息。而建筑图纸反映了内部结构信息，但忽略了外观信息。到底提取哪些信息，忽略哪些信息，取决于模型的目的。
第四，模型可以有多种表现形式，例如图纸、影像、公式以及电脑中的文件等等。具体采用哪种形式，取决于要解决的问题和当前的技术水平。
最后，模型是一种人造物，大自然本身是不存在模型的。
软件开发是一个建模过程
说到这儿，不知道你发现了没有？其实计算机软件也是一种模型。这是因为，计算机软件也是为了满足业务需求，对现实世界的事物和逻辑进行的模拟。所以，我们开发计算机软件的过程也是一个建模过程。
软件本质上是运行在机器上的一串二进制流，我们姑且称之为“机器模型”。我画了一张图，表示了现实世界和机器模型之间的关系。

我们看到，在机器模型和丰富多彩的现实世界之间存在着巨大的鸿沟，所以，用二进制直接为现实世界建模是非常困难的，这也是软件开发如此困难的原因之一。
那么，如何克服这一障碍呢？打个比方，假如我们想爬到房顶上去，太高了上不去怎么办，那就搬个梯子，一步一步地爬上去。
软件开发的道理是一样的。可以把由现实世界到机器模型的过程分成几步，一步一步地走。传统软件工程中，从现实世界到机器模型的过程，一般是这样的：

第一步是捕获行为需求，研究为了满足业务需求需要有怎样的流程和功能，可以用传统的用例分析来做，也可以用咱们这里的事件风暴。
第二步是分析，在行为需求的基础上，对现实世界中领域知识或者说业务概念进行分析和提炼，形成分析模型。尽管分析模型反映的仍然是业务概念，然而是经过抽象得来的，更加严谨、精练和一致，因此比行为需求更加接近实现。
第三步是设计，在分析模型的基础上，增加技术关注点，进行架构设计、详细设计、数据库设计等，形成设计模型。设计模型介于分析模型和代码之间。
第四步是编写代码。代码经过编译后，就成为了运行在机器上的“机器模型”了。
其实，第二步中的分析，就是对领域知识的抽象和提炼的过程，所以分析模型也可以称为领域模型，这个过程也可以叫做领域建模。
但是，很多伙伴在开发软件时，并没有经过领域建模这一步，而是直接进行设计和编码。如果是简单系统的话还可以，如果是复杂系统，就会出现很多问题了。
DDD 领域模型与传统方法的不同之处
看到这儿你可能会问了，既然传统软件工程也有领域模型，那 DDD 的领域模型与传统的方法又有什么不同呢？
这两者之间有一个重要区别：DDD 强调领域模型要兼顾业务和技术两个视角。
在传统软件工程里，建立分析模型强调完全从业务领域出发，不考虑技术视角。然后，才会把分析模型交给技术专家，转化为设计模型。两者的关系如下图：

这种方法虽然在理论上是完备的，但实践中常常会有问题。由于在分析阶段没有从技术视角考虑，那么在转化为设计模型的时候，就可能发现有些分析模型很难实现，需要通过复杂的转换，才能适应软件开发的要求，因此两种模型之间就产生了比较大的差距。
所以，在之后的开发过程中，开发人员往往只是聚焦于设计模型，而将分析模型束之高阁。时间久了，分析模型与系统实现之间的差异越来越大，也就失去了存在的意义。最终，技术实现与业务越来越远，软件系统也就难以真实反映业务需求了。
但是，DDD 的领域模型则是业务视角（原来的分析模型）和技术视角（原来的设计模型）的交集。它反映了业务人员和技术人员的共识。
尽管技术人员仍然要为领域模型增加实现细节，形成设计模型，但设计模型必须严格遵循领域模型。对领域模型的修改，必须由业务和技术双方达成一致。这样，就避免了传统软件工程中分析模型和设计模型相互割裂的风险，如下图：

为了表达 DDD 的侧重点，我们把传统的软件开发过程修改为下面这样：

在这个图中，我们直接用领域建模代替了原来的分析步骤。同时，把原来的设计和编码合并成了模型的实现，这是因为，从敏捷的角度来看，设计和编码常常会融合在一起。
模型驱动设计
围绕领域模型进行开发的方法，在 DDD 中称为模型驱动设计（Model-Driven Design），是 DDD 的核心模式之一。这个模式可以概括为两点：
领域模型要和业务需求一致；
系统实现要和领域模型一致。
领域模型要和业务需求一致
首先我们来看看领域模型和业务需求一致。
DDD 非常重视对业务需求中领域知识的消化。虽然我们从事件风暴就开始消化了，但领域建模才是消化知识的核心。在这个过程中，事件风暴里遗留的不清晰的部分会得到解决，并且还会发现新的知识。
事实上，事件风暴和领域建模有一个重要的区别：事件风暴仅仅追求“形似”，也就是说业务是怎样运作的，事件风暴就怎样反映。
而领域模型不仅要和需求“形似”，更要“神似”。也就是说，领域模型不仅要对业务进行直观模拟，更要经过提炼，形成浓缩的知识。
什么意思呢？这里主要是指两点，
第一点，是通过抽象思维得到更“深刻”的模型。比如说，我们从企业、开发中心等概念中抽象出组织和组织类别，从人事人员、销售人员中抽象出岗位等等。这使模型中的知识不再停留在业务的表面，而是深入到业务的本质，有利于开发出更加灵活简洁的系统。
第二点，是通过深入思考得到更“丰富”的模型。比如说，我们通过分析“取员工上级”的操作，识别出了员工和组织之间关于组织负责人的关联。另外，作为领域知识的一部分，我们还补充了更多的业务规则，这些都使模型更加丰富。蕴含丰富知识的领域模型，可以让我们在开发的时候不容易遗漏重要的领域概念和规则。
另外，领域模型和业务相一致，必须通过业务人员和技术人员的协作才能完成。业务人员的参与，能为领域模型带来专业的领域知识，而技术人员可以为领域模型带来更高的抽象性和严谨性。
而且，技术视角的加入还为领域模型的选择提供了参考。前面我们说过，模型是一种人造物。既然是人造的，就会带入主观因素，对于同一业务，可能会构建出不同形式的领域模型，这些模型可能都“对”，关键在于哪一个“更好”。这时候，技术人员从技术视角出发，往往可以发现，有些模型更容易进行技术实现。所以，尽管领域模型中都是业务概念，却可以通过技术视角选出更恰当的模型。
系统实现和领域模型一致
模型驱动设计的第二个要点是系统实现和领域模型一致。
如果修改了领域模型，那么系统实现必然也要修改；反之，如果系统实现发生了变化，也很有可能导致模型的变化。
这背后还隐含了一个推论：领域模型中的每个元素，都应该通过某种方式在系统实现中有所体现。反过来说，如果发现领域模型中的某个元素不需要落实到实现里，那么就应该在领域模型里删除这个元素。这也是技术人员参与到领域建模中的一个原因。
根据领域模型进行系统实现的具体技术，我们在会后面的课程中介绍。
领域模型和业务需求一致、系统实现和领域模型一致，最终结果就是系统实现和业务需求总是一致的，避免了系统实现和业务需求差距越来越大，这个老大难问题。
领域模型与统一语言
除了模型驱动设计以外，DDD 中的另一个核心模式是统一语言（Ubiquitous Language）。
统一语言包含了两个层面的含义：一是业务和技术人员之间的语言是统一的，二是开发团队内部各角色之间的语言是统一的。最终结果就是每一行代码都能对应到统一语言，从而与业务保持一致。你可能已经发现了，统一语言和领域模型的目的是一致的。
统一语言的概念其实很容易理解，难点在于怎么真正在实践中贯彻。
要在实践里真正贯彻“统一语言”的理念，我们可以从统一语言的“物质基础”和“实际应用”这两个方面来考虑。领域模型、和词汇表（glossary）和业务规则表等文档性的制品，就是统一语言的“物质基础”。而业务和技术人员在开发过程中的沟通协作，就是统一语言的应用。
这两方面缺一不可。要用好统一语言，首先要建好领域模型、词汇表和业务规则表。没有这些，就无法对语言进行规范化和持久化。
另一方面，在所有的协作过程中，每当我们说到领域知识的词汇，都要看一下在领域模型中是否有所反映、大家对同一概念的理解是否一致、已经废弃的词汇是否还在使用等等。
如果发现语言与模型不一致，就要及时纠正，让两者恢复一致。编写代码的时候，也要使代码中的各种命名与模型和词汇表保持一致。在前面的课程里，咱们在建模中模拟了你我两人的对话过程，就是希望你能够体会到语言在沟通中的应用。
在领域建模的过程中，我们也强调了，实体、关联等元素翻译成自然语言应该怎么说。事实上，好的模型中的任何元素，都应该可以和自然语言进行顺畅地双向转换。
总结
这节课的主要内容就讲完了。我们来总结一下。
今天我们首先介绍了模型的概念，然后说明了软件开发也是一个建模过程。为了跨越现实世界和机器模型之间的鸿沟，人们采用了“分步走”的方式。其中，在传统软件工程中的分析步骤产生的分析模型，也叫做领域模型。
但是，DDD 的领域模型与传统软件工程有一个重要的区别，就是，DDD 强调领域模型要兼顾业务和技术两个视角，而不像传统方法那样，只关注业务视角。
所以，我们可以说：DDD 的领域模型是为了满足业务需求，对领域知识进行提炼和抽象的产物，反映了业务和技术人员的共同视角。一方面，它能够全面和深刻地反映领域知识，另一方面又能方便地转化为技术实现。
DDD 的核心模式之一：模型驱动设计就是围绕领域模型展开的。它有两个要点：领域模型和业务需求要保持一致；系统实现和领域模型也要保持一致。最终的结果就是系统实现和业务需求保持一致。
除此之外，DDD 还有另一个核心模式：统一语言。要用好统一语言，一方面要建立好领域模型、词汇表等“物质基础”，另一方面要在沟通协作的过程中，不断保持模型、语言和系统实现的一致性。
这节课理论比较多，可能比较抽象，希望你在实践中不断体会。
思考题
1. 在你的实际项目中，有没有遇到过业务和技术理解不一致的情况，造成了什么后果？
2. 在你的实际项目中，有没有做过类似领域建模的事情，是否能够坚持下来？
好，今天的课程结束了，有什么问题欢迎在评论区留言，下节课，我们开始过渡到模型的实现，讲一下怎样根据领域模型进行数据库设计。
111
